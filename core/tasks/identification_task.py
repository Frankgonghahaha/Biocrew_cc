#!/usr/bin/env python3
"""
微生物识别任务
定义工程微生物识别任务的创建和配置
"""

from crewai import Task
from textwrap import dedent
from core.tools.database.factory import DatabaseToolFactory


class MicroorganismIdentificationTask:
    """微生物识别任务类"""
    
    def __init__(self, llm):
        """
        初始化微生物识别任务
        
        Args:
            llm: 大语言模型实例
        """
        self.llm = llm

    def create_task(self, agent, user_requirement: str) -> Task:
        """
        创建微生物识别任务实例
        
        Args:
            agent: 执行任务的智能体
            user_requirement: 用户需求描述
            
        Returns:
            Task: 配置好的任务实例
        """
        # 创建工具实例
        tools = DatabaseToolFactory.create_all_tools()
        
        task = Task(
            description=dedent(f"""
                根据水质净化目标识别工程微生物组，包含功能菌。
                
                识别步骤：
                # 1. 分析水质净化目标（水质治理指标+目标污染物）
                # 2. 从用户输入中准确识别目标污染物并将其翻译为标准科学术语
                # 3. 使用专门的数据查询工具查询相关基因和微生物数据
                # 4. 从公开数据库（Web of Science、HydroWASTE、KEGG、NCBI、EnviPath）获取补充领域知识
                # 5. 使用EnviPath工具查询环境化合物代谢路径信息
                # 6. 使用KEGG工具查询pathway、ko、genome、reaction、enzyme、genes等生物代谢信息
                # 7. 使用NCBI基因组查询工具获取推荐微生物的基因组Assembly Accession信息
                # 9. 判断是否可获取全基因组信息
                # 10. 评估微生物的生长环境要求
                # 11. 分析微生物对目标污染物的降解效果
                
                工具调用策略：
                # 1. 首先使用PollutantSummaryTool或PollutantDataQueryTool确定污染物的标准化名称
                # 2. 使用EnviPathTool查询目标污染物的完整代谢路径，重点关注每步反应的EC编号和酶名称
                # 3. 基于EC编号使用KEGG工具查询对应的基因和代谢信息，也可使用EC编号直接查询基因：{{"ec_number": "1.14.12.7"}}
                # 4. 使用NCBI基因组查询工具获取推荐微生物的基因组Assembly Accession信息
                # 5. 使用UniProtTool查询关键降解酶的蛋白质序列和功能特性，进行信息核对和设计验证
                # 6. 在获取UniProt蛋白质序列后，使用基于SQL的蛋白质序列查询工具(ProteinSequenceQuerySQLTool)进行序列对比分析
                # 7. 序列对比参数：使用查询到的蛋白质序列作为输入，设置最小相似度70%，最大E-value为1e-5，最小比对长度为50
                # 8. 在序列对比中提供BLAST的三个关键阈值：相似度、E-value和比对长度
                # 9. 使用降解功能微生物识别工具(DegradingMicroorganismIdentificationTool)识别降解功能微生物及其互补微生物
                # 10. 当KEGG工具根据EC编号查询基因无结果时，应基于酶的功能类别进行合理推断
                
                用户需求：{user_requirement}
                
                请严格遵循以下输出格式：
                
                # 工程微生物组识别报告：降解[污染物标准名称]的微生物组合
                
                ## 1. 目标污染物识别
                - **原始用户输入**：[用户原始输入]
                - **标准科学术语**：[标准化术语]
                - **化学式**：[化学式]
                - **CAS号**：[CAS号]
                - **分类**：[污染物分类]
                
                ## 2. 降解路径分析（基于EnviPathTool）
                [以表格形式展示降解路径，包含步骤、反应描述、底物、产物、EC编号、酶名称、相关基因（查询或推断）等信息]
                
                > **完整降解路径**：[起始物质] → [中间产物1] → [中间产物2] → ... → CO₂ + H₂O  
                > **关键限速步骤**：[关键步骤说明]
                
                ---
                
                ## 3. 推荐功能微生物
                [以表格形式展示推荐微生物列表，包含微生物名称、科学分类信息、降解能力描述、相关基因列表（查询或推断）、代谢路径关键步骤、数据来源、置信度评估、NCBI Assembly Accession等信息]
                
                > **备注**：[备注信息]
                
                ---
                
                ## 4. 生长环境评估
                [以表格形式展示每个微生物的生长环境要求，包括温度范围、pH范围、盐度要求、氧气需求、特殊条件等]
                
                > **兼容性分析**：[微生物间的环境兼容性分析]
                
                ---
                
                ## 5. 全基因组信息获取判断
                [以表格形式展示每个微生物的全基因组信息获取情况]
                
                ---
                
                ## 6. 降解效果分析
                [以表格形式展示每个微生物的降解效率、中间产物积累、最终产物、是否矿化等信息]
                
                > **结论**：[降解效果结论]
                
                ---
                
                ## 7. 微生物组推荐组合表
                [以表格形式展示最终推荐的微生物组合，包含微生物名称、科学分类信息、降解能力描述、相关基因列表（查询或推断）、代谢路径关键步骤、数据来源、置信度评估、NCBI Assembly Accession等信息]
                
                > **推荐理由**：[推荐理由]
                
                ---
                
                ## 8. 序列对比分析结果
                [以表格形式展示关键降解酶的序列对比结果，包含UniProt ID、相似酶序列、相似度、E-value、比对长度、功能域信息等]
                
                > **序列分析结论**：[序列对比分析的主要发现]
                
                ---
                
                ## 9. 数据完整性与可信度评估
                [以表格形式展示各项数据的可用性、来源、备注等信息]
                
                > **主要局限**：[主要局限性说明]
                
                ---
                
                ## 10. 结论与建议
                **最终推荐工程微生物组**：  
                **[微生物A] + [微生物B]**  
                
                ✔️ **科学依据**：
                [科学依据列表]
                
                🔧 **后续建议**：
                [后续建议列表]
                
                --- 
                
                **附录：NCBI基因组下载链接**
                [提供NCBI基因组下载链接]
            """),
            agent=agent,
            expected_output=dedent("""
                完整的工程微生物组识别报告，包含：
                1. 目标污染物识别结果
                2. 详细的降解路径分析
                3. 推荐的功能微生物列表
                4. 微生物的生长环境评估
                5. 全基因组信息获取判断
                6. 降解效果分析
                7. 最终推荐的微生物组组合
                8. 关键降解酶的序列对比分析结果
                9. 数据完整性与可信度评估
                10. 结论与建议
                
                报告应包含基于EC编号查询的基因信息，当查询无结果时应提供基于推断的结果和置信度评估。
                序列对比分析应包含BLAST的三个关键阈值：相似度、E-value和比对长度。
            """),
            tools=tools
        )
        
        return task